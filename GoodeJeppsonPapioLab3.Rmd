---
title: "585Lab3"
author: "Goode, Jeppson, Papio"
date: "February 16, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(purrr)
```


First step, read in the files. 


```{r}
file1 <- lapply(excel_sheets("spreadsheets/FileOne.xlsx"), read_excel, path = "spreadsheets/FileOne.xlsx")
file2 <- lapply(excel_sheets("spreadsheets/FileTwo.xlsx"), read_excel, path = "spreadsheets/FileTwo.xlsx")

```

Before we can combine the files, or even the semesters, we need to do a little bit of cleaning.

```{r }
# First up, file 1:

file1[[1]]
# file 1 sem 1 is missing column titles
names(file1[[1]])[c(1,2)]<-c("ID", "Test")
file1[[1]] <- file1[[1]] %>% mutate ( Sem =1)


file1[[2]]
# file 1 sem 2 is also missing column titles
names(file1[[2]])[c(1,2)]<-c("ID", "Test")
# delete extra column of NA's
file1[[2]] <- file1[[2]][,-15]
file1[[2]] <- file1[[2]] %>% mutate ( Sem = 2)

file1[[3]]
# file 1 sem 3 is also missing column titles
names(file1[[3]])[c(1,2)]<-c("ID", "Test")
file1[[3]] <- file1[[3]] %>% mutate ( Sem =3)

file1[[4]]
# file 1 sem 4 is also missing column titles
names(file1[[4]])[c(1,2)]<-c("ID", "Test")
# the ids for sem 4 have an extra 100 in them?
file1[[4]] <- file1[[4]] %>% mutate ( ID=ID -100, Sem =4)

# combine the list of data frames into one dataframe
f1 <- do.call("rbind", file1)

# make sure all "test" resposes are the same case
f1$Test <- gsub("PRE", "Pre", f1$Test)
f1$Test <- gsub("POST", "Post", f1$Test)
f1

#fix names of the columns
names(f1)[c(14, 15,18)] <- c("Normalized Change", "Gender", "Treatment Part 2")
f1


```

```{r }
# Next up, file 2:

file2[[1]]
# file 1 sem 1 is missing column titles
names(file2[[1]])[c(1,2)]<-c("ID", "Test")
file2[[1]] <- file2[[1]] %>% mutate (Sem =1)


file2[[2]]
# file 2 sem 2 is also missing column titles
names(file2[[2]])[c(1,2)]<-c("ID", "Test")
file2[[2]] <- file2[[2]] %>% mutate ( Sem =2)

file2[[3]]
# file 2 sem 3 is also missing column titles
names(file2[[3]])[c(1,2)]<-c("ID", "Test")
file2[[3]] <- file2[[3]] %>% mutate ( Sem =3)

file2[[4]]
# file 1 sem 4 is also missing column titles
names(file2[[4]])[c(1,2)]<-c("ID", "Test")
# the ids for sem 4 have an extra 1100 in them?
file2[[4]] <- file2[[4]] %>% mutate ( ID= ID -1100, Sem =4)

# looking back throu the dimensions of all 4 semesters, semester one is missing the column "MTH 3", so we'll add in a column of NAS
file2[[1]] <- file2[[1]] %>% mutate ("MTH 3" = NA)
#but I would like the columns to still be in the same order, so I will rearrange them
file2[[1]]  <- file2[[1]][,c(1:16,41,17:40)]

# combine the list of data frames into one dataframe
f2 <- do.call("rbind", file2)

# make sure all "test" resposes are the same case
f2$Test <- gsub("PRE", "Pre", f2$Test)
f2$Test <- gsub("POST", "Post", f2$Test)
f2 %>% arrange(ID)
names(f2)[37]<- "Gender"


```

Now that we have the two files in two dataframes we can start working on getting them combined into one dataframe.

We have a split key so we will need to create two dataframes for each file before continuing.

First, we should extract the all the information about the student that is constant throughout the semester.

```{r}

keys1 <- f1 %>% select(ID, Gender, Characteristic, `Treatment Part 1`, `Treatment Part 2`, Sem)
keys2 <- f2 %>% select(ID, Gender, Characteristic, `Treatment Part 1`, `Treatment Part 2`, Sem)
#combine the two together
keys <- rbind(keys1, keys2)



#since there are duplicates, we want to pull out the unique, complete, values
keys <- unique(keys)
keys <- keys[complete.cases(keys),]
keys %>% arrange(ID)
```


Now we can join the f1 and f2 with our dataframe of keys

```{r}
#take gender and characeristic out of files 1 and 2
F1 <- f1[,-c(15:19)]
F2 <- f2[,-c(37:41)]

# Join the dataframes
first <- left_join(keys, F1, by=("ID"))
first %>% arrange(ID)
final <- left_join(first, F2, by=c("ID","Test"))
final %>% arrange(ID)

```

come up with a visual summary comparing pre and post-test scores from the two tests facetted by semester. Try to work gender into this display in a meaningful way.
```{r}
subset.final <- final %>% select(ID, Gender, Sem, Test, Total.x, Total.y) %>% arrange(ID)
names(subset.final)[c(5,6)] <- c("Total.Test1", "Total.Test2")
subset.final %>% arrange(ID)

subset.final <- unique(subset.final)
final.final <- subset.final %>% unite(score, Total.Test1, Total.Test2)%>% spread(key=Test, value=score)%>% separate(Post, c("Post1", "Post2"))%>% separate(Pre, c("Pre1", "Pre2"))

final.final %>% gather(Post, value=Score, 4:5)%>% gather(Test, value=Score2, 4:5) %>% ggplot() + geom_point(aes(x=as.integer(Score), y=as.integer(Score2), shape=Test, colour=Gender))+facet_grid(Sem~Test)

```



