---
title: "585Lab3"
author: "Goode, Jeppson, Papio"
date: "February 16, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(purrr)
```

## Data Cleaning

First step, read in the files. 


```{r}
file1 <- lapply(excel_sheets("spreadsheets/FileOne.xlsx"), read_excel, path = "spreadsheets/FileOne.xlsx")
file2 <- lapply(excel_sheets("spreadsheets/FileTwo.xlsx"), read_excel, path = "spreadsheets/FileTwo.xlsx")

```

Before we can combine the files, or even the semesters, we need to do a little bit of cleaning.

```{r }
# First up, file 1:

file1[[1]]
# file 1 sem 1 is missing column titles
names(file1[[1]])[c(1,2)]<-c("ID", "Test")
file1[[1]] <- file1[[1]] %>% mutate ( Sem =1)


file1[[2]]
# file 1 sem 2 is also missing column titles
names(file1[[2]])[c(1,2)]<-c("ID", "Test")
# delete extra column of NA's
file1[[2]] <- file1[[2]][,-15]
file1[[2]] <- file1[[2]] %>% mutate ( Sem = 2)

file1[[3]]
# file 1 sem 3 is also missing column titles
names(file1[[3]])[c(1,2)]<-c("ID", "Test")
file1[[3]] <- file1[[3]] %>% mutate ( Sem =3)

file1[[4]]
# file 1 sem 4 is also missing column titles
names(file1[[4]])[c(1,2)]<-c("ID", "Test")
# the ids for sem 4 have an extra 100 in them?
file1[[4]] <- file1[[4]] %>% mutate ( ID=ID -100, Sem =4)

# combine the list of data frames into one dataframe
f1 <- do.call("rbind", file1)

# make sure all "test" resposes are the same case
f1$Test <- gsub("PRE", "Pre", f1$Test)
f1$Test <- gsub("POST", "Post", f1$Test)
f1

#fix names of the columns
names(f1)[c(14, 15,18)] <- c("Normalized Change", "Gender", "Treatment Part 2")
f1


```

```{r }
# Next up, file 2:

file2[[1]]
# file 1 sem 1 is missing column titles
names(file2[[1]])[c(1,2)]<-c("ID", "Test")
file2[[1]] <- file2[[1]] %>% mutate (Sem =1)


file2[[2]]
# file 2 sem 2 is also missing column titles
names(file2[[2]])[c(1,2)]<-c("ID", "Test")
file2[[2]] <- file2[[2]] %>% mutate ( Sem =2)

file2[[3]]
# file 2 sem 3 is also missing column titles
names(file2[[3]])[c(1,2)]<-c("ID", "Test")
file2[[3]] <- file2[[3]] %>% mutate ( Sem =3)

file2[[4]]
# file 1 sem 4 is also missing column titles
names(file2[[4]])[c(1,2)]<-c("ID", "Test")
# the ids for sem 4 have an extra 1100 in them?
file2[[4]] <- file2[[4]] %>% mutate ( ID= ID -1100, Sem =4)

# looking back throu the dimensions of all 4 semesters, semester one is missing the column "MTH 3", so we'll add in a column of NAS
file2[[1]] <- file2[[1]] %>% mutate ("MTH 3" = NA)
#but I would like the columns to still be in the same order, so I will rearrange them
file2[[1]]  <- file2[[1]][,c(1:16,41,17:40)]

# combine the list of data frames into one dataframe
f2 <- do.call("rbind", file2)

# make sure all "test" resposes are the same case
f2$Test <- gsub("PRE", "Pre", f2$Test)
f2$Test <- gsub("POST", "Post", f2$Test)
f2 %>% arrange(ID)
names(f2)[37]<- "Gender"


```

Now that we have the two files in two dataframes we can start working on getting them combined into one dataframe.

We have a split key so we will need to create two dataframes for each file before continuing.

First, we should extract the all the information about the student that is constant throughout the semester.

```{r}

keys1 <- f1 %>% select(ID, Gender, Characteristic, `Treatment Part 1`, `Treatment Part 2`, Sem)
keys2 <- f2 %>% select(ID, Gender, Characteristic, `Treatment Part 1`, `Treatment Part 2`, Sem)
#combine the two together
keys <- rbind(keys1, keys2)



#since there are duplicates, we want to pull out the unique, complete, values
keys <- unique(keys)
keys <- keys[complete.cases(keys),]
keys %>% arrange(ID)
```


Now we can join the f1 and f2 with our dataframe of keys

```{r}
#take gender and characeristic out of files 1 and 2
F1 <- f1[,-c(15:19)]
F2 <- f2[,-c(37:41)]

# Join the dataframes
first <- left_join(keys, F1, by=("ID"))
first %>% arrange(ID)
final <- left_join(first, F2, by=c("ID","Test"))
final %>% arrange(ID)

```

come up with a visual summary comparing pre and post-test scores from the two tests facetted by semester. Try to work gender into this display in a meaningful way.
```{r}
subset.final <- final %>% select(ID, Gender, Sem, Test, Total.x, Total.y) %>% arrange(ID)
names(subset.final)[c(5,6)] <- c("Total.Test1", "Total.Test2")
subset.final %>% arrange(ID)

subset.final <- unique(subset.final)
final.final <- subset.final %>% unite(score, Total.Test1, Total.Test2)%>% spread(key=Test, value=score)%>% separate(Post, c("Post1", "Post2"))%>% separate(Pre, c("Pre1", "Pre2"))

final.final %>% gather(Post, value=Score, 4:5)%>% gather(Test, value=Score2, 4:5) %>% ggplot() + geom_point(aes(x=as.integer(Score), y=as.integer(Score2), shape=Test, colour=Gender))+facet_grid(Sem~Test)

```
There are two variables for semester (one from each test dataframe). We want to check to see if the two variables agree. This is done by looking at the summary of the differences of the two variabes. As seen in the code below, the variables do agree besides for in several cases where NAs appear in the differences. These are due to cases when students do not have responses for one of the tests.

```{r}
# Summary of differences
final %>%
  mutate(Sem.Diff = Sem.x - Sem.y) %>%
  select(Sem.Diff) %>%
  summary()

# Summary of semester variable from test 1 dataframe
final %>%
  select(Sem.x) %>%
  summary()

# Summary of semester variable from test 2 dataframe
final %>%
  select(Sem.y) %>%
  summary()
```

It is decided to only use the variable from the test 1 data frame since it has less NA's. However, this is something that it would be a good idea to look more into. The variable for semester from the test 2 dataframe is removed, and the variable for semester from the test 1 dataframe is renamed. The variables for test 1 and test 2 total score are also renamed.

```{r}
# Remove the second 
final <- final %>%
  select(-Sem.y)

# Renaming variables
names(final)[19] <- "Semester"
names(final)[15] <- "Test1_Total"
names(final)[52] <- "Test2_Total"
```

## Graphs Comparing Pre and Post Scores

Several ways of visually comparing the pre and post scores are included below. The first considered is a scatterplot of pre and post scores. To do this, the final dataset first needs to be adjusted to get pre and post scores in two separated columns. The code below was run to do this and error appeared indicating "Duplicate identifiers for rows".

```{r}
# final %>%
#  select(ID, Gender, Test, Test1_Total, Semester) %>%
#  spread(key = Test, value = Test1_Total) %>%
#  head()
```

By consdering the number of IDs and unique IDs in the key dataframe created earlier, it is found that the lengths differ. It was discovered that there are discrepancies between the test 1 and test 2 variables for characteristic and gender. There are several examples below of students that show these discrepancies.

```{r}
# Comparing lengths of key IDs and unique IDs
length(keys$ID)
length(unique(keys$ID))

# Example of disagreement in characteristic value
final %>%
  filter(ID == "30033") %>%
  select(ID, Characteristic)

# Example of disagreement in gender value
final %>%
  filter(ID == "40030") %>%
  select(ID, Gender)
```

The discrepancies from test 2 dataframe occur at the end of the final dataframe. The assumption that the values from the test 1 dataframe are correct is made. However, this is something that the data collector should be consulted about. Thus, the first 346 rows before the IDs start repeating are kept.

```{r}
# Removing rows with dis
final <- final %>%
  slice(1:346)
```

With these rows removed, the dataframe can be transformed into the necessary formats. The test 1 and test 2 scores are separated into two dataframes with pre and post scores in two columns. Only the variables of ID, Gender, Test, and Semester are kept. Additionally, a variable of the difference between the post and pre scores is created (Post-Pre).

```{r}
# Data for test 1 scores
graph.data.1 <- final %>%
  select(ID, Gender, Test, Test1_Total, Semester) %>%
  spread(key = Test, value = Test1_Total) %>%
  mutate(Difference = Post - Pre)

# Data for test 2 scores
graph.data.2 <- final %>%
  select(ID, Gender, Test, Test2_Total, Semester) %>%
  spread(key = Test, value = Test2_Total) %>%
  mutate(Difference = Post - Pre)
```

### Test 1 Scores

```{r, warning = FALSE}
ggplot(graph.data.1, aes(x = Pre, y = Post, color = Gender)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  facet_wrap( ~ Semester)

ggplot(graph.data.1, aes(x = Gender, y = Difference)) + 
  geom_boxplot() +
  facet_wrap( ~ Semester) +
  coord_flip()

ggplot(graph.data.1, aes(x = Difference)) + 
  geom_density(data = subset(graph.data.1, Gender == 'Female'),fill = "red", alpha = 0.5) +
  geom_density(data = subset(graph.data.1, Gender == 'Male'),fill = "blue", alpha = 0.5) +
  facet_wrap( ~ Semester)
```

### Test 2 Scores

```{r, warning = FALSE}
ggplot(graph.data.2, aes(x = Pre, y = Post, color = Gender)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  facet_wrap( ~ Semester)

ggplot(graph.data.2, aes(x = Gender, y = Difference)) + 
  geom_boxplot() +
  facet_wrap( ~ Semester) +
  coord_flip()

ggplot(graph.data.2, aes(x = Difference)) + 
  geom_density(data = subset(graph.data.2, Gender == 'Female'),fill = "red", alpha = 0.5) +
  geom_density(data = subset(graph.data.2, Gender == 'Male'),fill = "blue", alpha = 0.5) +
  facet_wrap( ~ Semester)
```





